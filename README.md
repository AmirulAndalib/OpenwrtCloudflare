# PiOpenwrtCloudflare
This is a colection of scripts and instructions to on how to setup a cloudflare tunnel on an Rasberry Pi4 running as a OpenWrt router

Scripts:
cloudflare-service.sh
  This script is used to run cloudflared as a service on OpenWrt
  IMPORTANT this needs to be copied into the /etc/init.d/ folder with no file extention (remove the.sh) 
  rename this file from cloudflared-service.sh and save as just cloudlfared and will look like
  /etc/init.d/cloudflared
  
  This service will now appear in the startup screen

cloudflare-update.sh
  This script will download the latest copy of cloudflared from thier github and replace the exisitng binary
  this can also be used for the inital download and setup of the binary
 
  Setup a cron job to do this as a scheduled task
  example Run at 11:38 am each day
  38 11 * * * /root/cloudflared-update.sh
  Example run at midnight each day
  0 0 * * * /root/cloudflared-update.sh








Manual install (DRAFT)
Openwrt Rasberry Pi 4 Router with Cloudflare tunnels


prerequisites:
Raspberry Pi 4 with OpenWrt installed and functioning correctly
1. open ssh session
2. opkg update
3. opkg install nano wget-ssl
4. have a registered domain name 
5. create a cloudflare account
6. add your site to your cloudflare account and have it manage your DNS



Install and setup

1. Open a ssh session on your Openwrt Rasberry Pi
2. wget https://github.com/cloudflare/cloudflared/releases/latest/download/cloudflared-linux-arm64 
3. mv cloudflared-linux-arm64 /usr/bin/cloudflared
4. chmod 755 /usr/bin/cloudflared
5. cloudflared tunnel login
5.1 you will be prompted to login into your account with a URL generated by cloudflared. 
	This will allow you to select the domain you which to use for the zero trust access tunnels
6.	Next Create a new tunnel with the following command replacing <TunnelName> 
6.1	cloudflared tunnel create <TunnelName>
7.	This will generate the tunnel and the UUID and cert
	these can be found in the /root/.cloudflared folder
	Note your UUID which is the name of the .json file eg 2g1c1ada-b3d4-4378-9219-3511a39b3158.json
8. 	create the route and execute
8.1	cloudflared tunnel route dns <TunnelName> <Domain Name> eg cloudflared tunnel route dns MyTunnel catdog.com
9. In the cloudflare console go to your site then DNS
10. add a new DNS record
10.1	TYPE = CNAME
		NAME = SITE Name (eg mysite) which will translaite into  like mysite.domainname.com 
		TRAGET = <UUID.cfargotunnel.com> eg 2g1c1ada-b3d4-4378-9219-3511a39b3158.cfargotunnel.com
		mysite.domainname.com is an alias of 2g1c1ada-b3d4-4378-9219-3511a39b3158.cfargotunnel.com and has its traffic proxied through Cloudflare.
11.		Create the yml config file for your site
		touch config.yml
		nano config.yml
		now to structure the file
		
		tunnel = your UUID
		credentials-file: is the file that was created when you established the tunnel and lives in the folder /root/.cloudflared/ 
		ingress is all the sites you want to present through the tunnel.
		an example is below create your for the site your representing and save this file
		


tunnel: 2g1c1ada-b3d4-4378-9219-3511a39b3158
credentials-file: /root/.cloudflared/2g1c1ada-b3d4-4378-9219-3511a39b3158.json

ingress:
  - hostname: opent.mydomain.nz
    service: http://localhost:80
  - hostname: netdata.mydomain.nz
    service: http://localhost:8880
  - hostname: ssh.mydomain.nz
    service: ssh://192.168.1.1:22
  - service: http_status:404

you can now test the tunnel with /usr/bin/cloudflared tunnel --config /root/.cloudflared/config.yml run <TunnelName> and see the output on the screen
once connected the tunnel will be up.

12. setting up as a service 

	In the folder ./etc/init.d/ you will need to create a file for cloudflared
	cd /etc/init.d
	touch cloudflared
	chmod 755 cloudflared
	nano cloudflared
	
	and create the following script and edit as needed
	
	
//#!/bin/sh /etc/rc.common
//# Cloudflared tunnel script
//#

START=10
STOP=15
RESTART=20
//# fix the cf buffer issues
sysctl -w net.core.rmem_max=2500000

//#start commands
start() {
        echo start
        # commands to launch cloidflared tunnel 
        /usr/bin/cloudflared tunnel --config /root/.cloudflared/config.yml run OpenTun &> /root/.cloudflared/tunnellogs.txt &
        # execute the tunnel and log to the tunnellogs file
}

stop() {
        echo stop
        # commands to kill application
        killall -9 cloudflared
}
restart() {
        echo restart
        killall -9 cloudflared
        sleep 2
        /usr/bin/cloudflared tunnel --config /root/.cloudflared/config.yml run OpenTun &> /root/.cloudflared/tunnellogs.txt &
}

# end of script

start your tunnel with 
/usr/bin/cloudflared tunnel --config /root/.cloudflared/config.yml run OpenTun &> /root/.cloudflared/tunnellogs.txt &


14. back to the cloudflare zero truct console and under access check the tunnels and make sure your tunnel is up
15. create an applicaiton to access your site 
	go to applicaiton and click add an application
	then Self hosted
	the rest is self explanitiory :)
	
	good luck
	
